<!DOCTYPE html>

<html>
<head>
  <title>cliffhanger.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>cliffhanger.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>MRU cache for callbacks.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Cache = <span class="hljs-built_in">require</span>(<span class="hljs-string">'magazine'</span>)

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Ever increasing serial value with no maximum value.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Monotonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'monotonic'</span>).asString

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Exceptions with context that can be caught by type.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> interrupt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'interrupt'</span>).createInterrupter(<span class="hljs-string">'bigeasy.cliffhanger'</span>)

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create a Cliffhanger. The optional <code>cache</code> argument is a common cache from
which to create a magazine.</p>

            </div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cliffhanger</span> (<span class="hljs-params">cache</span>) </span>{
    cache = cache || <span class="hljs-keyword">new</span> Cache
    <span class="hljs-keyword">this</span>._magazine = cache.createMagazine()
    <span class="hljs-keyword">this</span>._cookie = <span class="hljs-string">'0'</span>
}

</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Create a cookie that will invoke the given callback.</p>

            </div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Cliffhanger.prototype.invoke = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">var</span> cookie = <span class="hljs-keyword">this</span>._cookie = Monotonic.increment(<span class="hljs-keyword">this</span>._cookie, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">this</span>._magazine.put(cookie, { <span class="hljs-attr">cookie</span>: cookie, <span class="hljs-attr">callback</span>: callback })
    <span class="hljs-keyword">return</span> cookie
}

</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Invoke the callback fro the given cookie with the given arguments. The
arguments are an array of arguments given to apply.</p>

            </div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Cliffhanger.prototype.resolve = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cookie, vargs</span>) </span>{
    <span class="hljs-keyword">var</span> invocation = <span class="hljs-keyword">this</span>._magazine.get(cookie), outcome = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> (invocation != <span class="hljs-literal">null</span>) {
        invocation.callback.apply(<span class="hljs-literal">null</span>, vargs)
        <span class="hljs-keyword">this</span>._magazine.remove(cookie)
        outcome = <span class="hljs-literal">true</span>
    }
    <span class="hljs-keyword">return</span> outcome
}

</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Expire any callbacks that have been in the cache since before the given
expiration time. The error is the optional error to pass to the callback,
otherwise an error is created by the Cliffhanger.</p>

            </div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Cliffhanger.prototype.expire = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">expired, error</span>) </span>{
    <span class="hljs-keyword">var</span> purge = <span class="hljs-keyword">this</span>._magazine.purge()
    <span class="hljs-keyword">while</span> (purge.cartridge &amp;&amp; purge.cartridge.when &lt; expired) {
        purge.cartridge.value.callback.call(<span class="hljs-literal">null</span>, error || interrupt({ <span class="hljs-attr">name</span>: <span class="hljs-string">'expired'</span> }))
        purge.cartridge.remove()
        purge.next()
    }
    purge.release()
}

</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>TODO Dubious. Never used it. Maybe rename to <code>cancelIf</code> and move it out of
the way? Shouldn’t the caller have a copy of all their cookies?</p>

            </div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Cancel all callbacks that match the given condition.</p>

            </div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>The condition is really dubious. If you’re going to test based on a cookie,
then you’re going to have to keep information associated with the cookie, so
why not just create a Magazine for yourself?</p>

            </div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>It is outgoing, but I’m going to keep it in case I’m using it somewhere.</p>

            </div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Cliffhanger.prototype.cancel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">condition, error</span>) </span>{
    <span class="hljs-keyword">var</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> vargs[<span class="hljs-number">0</span>] == <span class="hljs-string">'function'</span>) {
        condition = vargs.shift()
    } <span class="hljs-keyword">else</span> {
        condition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> }
    }
    error = vargs.shift()
    <span class="hljs-keyword">var</span> purge = <span class="hljs-keyword">this</span>._magazine.purge()
    <span class="hljs-keyword">while</span> (purge.cartridge) {
        <span class="hljs-keyword">if</span> (condition(purge.cartridge.value.cookie)) {
            purge.cartridge.value.callback.call(<span class="hljs-literal">null</span>, error || interrupt({ <span class="hljs-attr">name</span>: <span class="hljs-string">'canceled'</span> }))
            purge.cartridge.remove()
        } <span class="hljs-keyword">else</span> {
            purge.cartridge.release()
        }
        purge.next()
    }
}

<span class="hljs-built_in">module</span>.exports = Cliffhanger

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
